<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hedef AVM MÃ¼ÅŸteri Hizmetleri Paneli</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --primary-hover: #4f46e5; /* Indigo 600 */
            --bg-color: #f8fafc;      /* Slate 50 */
            --card-bg: #ffffff;
            --text-main: #1e293b;     /* Slate 800 */
            --text-muted: #64748b;    /* Slate 500 */
            --border-color: #e2e8f0;  /* Slate 200 */
            --radius: 12px;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            padding-bottom: 80px;
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f1f5f9;
            z-index: 10000; /* En Ã¼stte */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-icon {
            width: 64px; height: 64px;
            background: var(--bg-color);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1.5rem;
            color: var(--primary-color);
            font-size: 1.75rem;
        }

        /* --- Navbar --- */
        .navbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--text-main);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- Kartlar (Cards) --- */
        .panel-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .card-header-custom {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title-custom {
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body-custom {
            padding: 1.5rem;
            flex-grow: 1;
        }

        /* --- Ä°statistik KutularÄ± --- */
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            height: 100%;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .stat-icon {
            width: 56px; height: 56px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            margin-right: 1.25rem;
            flex-shrink: 0;
        }
        .stat-info h3 { font-size: 1.75rem; font-weight: 700; margin: 0; line-height: 1.2; color: var(--text-main); }
        .stat-info span { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Renkler */
        .bg-indigo-light { background: #e0e7ff; color: #4338ca; }
        .bg-emerald-light { background: #d1fae5; color: #065f46; }
        .bg-amber-light { background: #fef3c7; color: #92400e; }

        /* --- Grafikler --- */
        .chart-wrapper {
            position: relative;
            height: 320px; /* Grafik yÃ¼ksekliÄŸi artÄ±rÄ±ldÄ± */
            width: 100%;
        }

        /* --- Form AlanlarÄ± --- */
        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* --- Tablo --- */
        .table-responsive {
            border-radius: 0 0 var(--radius) var(--radius);
        }
        .table-custom {
            margin-bottom: 0;
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-custom thead th {
            background-color: #f8fafc;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .table-custom tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .table-custom tbody tr:hover { background-color: #f1f5f9; }

        /* --- Badges --- */
        .badge-status {
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.75rem;
            display: inline-block;
        }
        .badge-success { background: #dcfce7; color: #15803d; }
        .badge-warning { background: #fef9c3; color: #a16207; }
        .badge-danger { background: #fee2e2; color: #b91c1c; }
        .badge-neutral { background: #f1f5f9; color: #475569; }

        /* --- Butonlar --- */
        .btn-primary-custom {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .btn-primary-custom:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        .btn-icon {
            width: 32px; height: 32px;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px; border: 1px solid var(--border-color);
            color: var(--text-muted); background: white;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            border-color: var(--primary-color); color: var(--primary-color); background: #eef2ff;
        }

        /* --- Pagination --- */
        .pagination-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pagination .page-link {
            border-radius: 6px;
            margin: 0 3px;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 0.85rem;
        }
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Loading */
        #loader {
            position: fixed; inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- LOGIN EKRANI -->
    <div id="login-screen">
        <div class="login-card">
            <div class="login-icon">
                <i class="fa-solid fa-lock"></i>
            </div>
            <h4 class="mb-2 fw-bold text-dark">GÃ¼venli GiriÅŸ</h4>
            <p class="text-muted small mb-4">Panele eriÅŸmek iÃ§in ÅŸifrenizi giriniz.</p>
            
            <form onsubmit="checkPassword(event)">
                <div class="mb-3">
                    <input type="password" class="form-control text-center" id="passwordInput" placeholder="Åžifre" required>
                </div>
                <button type="submit" class="btn btn-primary-custom w-100">GiriÅŸ Yap</button>
            </form>
            <p id="loginError" class="text-danger small mt-2 d-none"><i class="fa-solid fa-circle-exclamation me-1"></i>HatalÄ± Åžifre!</p>
        </div>
    </div>

    <!-- ANA Ä°Ã‡ERÄ°K (BaÅŸlangÄ±Ã§ta Gizli) -->
    <div id="main-content" style="display: none;">

        <div id="loader">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
            <div class="fw-bold text-muted">Veriler Ä°ÅŸleniyor...</div>
        </div>

        <!-- Navbar -->
        <nav class="navbar sticky-top">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <div class="bg-indigo-light p-2 rounded-3 me-2">
                        <i class="fa-solid fa-headset"></i>
                    </div>
                    Hedef AVM MÃ¼ÅŸteri Hizmetleri
                </a>
                <div class="d-flex align-items-center">
                    <span class="badge bg-white text-success border px-3 py-2 d-flex align-items-center shadow-sm">
                        <span class="spinner-grow spinner-grow-sm me-2" role="status"></span>
                        CanlÄ± (5sn)
                    </span>
                </div>
            </div>
        </nav>

        <div class="container">

            <!-- 1. BÃ–LÃœM: Ä°statistik KartlarÄ± -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon bg-indigo-light">
                            <i class="fa-solid fa-phone"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statTotal">0</h3>
                            <span>Toplam Ã‡aÄŸrÄ±</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon bg-emerald-light">
                            <i class="fa-solid fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statResolved">0</h3>
                            <span>Ã‡Ã¶zÃ¼mlenen</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon bg-amber-light">
                            <i class="fa-solid fa-clock-rotate-left"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="statPending">0</h3>
                            <span>Bekleyen</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. BÃ–LÃœM: Grafikler -->
            <div class="row g-4 mb-5">
                <!-- Arama Nedenleri (GENÄ°Åž) -->
                <div class="col-lg-8">
                    <div class="panel-card">
                        <div class="card-header-custom">
                            <h6 class="card-title-custom"><i class="fa-solid fa-chart-bar text-muted"></i> En Ã‡ok Aranan Konular (Top 5)</h6>
                        </div>
                        <div class="card-body-custom d-flex align-items-center">
                            <div class="chart-wrapper">
                                <canvas id="topicChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- BÃ¶lgesel DaÄŸÄ±lÄ±m (DAR) -->
                <div class="col-lg-4">
                    <div class="panel-card">
                        <div class="card-header-custom">
                            <h6 class="card-title-custom"><i class="fa-solid fa-map-location-dot text-muted"></i> BÃ¶lgesel DaÄŸÄ±lÄ±m</h6>
                        </div>
                        <div class="card-body-custom d-flex align-items-center">
                            <div class="chart-wrapper">
                                <canvas id="regionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. BÃ–LÃœM: Yeni KayÄ±t Formu -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="panel-card border-start border-4 border-primary">
                        <div class="card-header-custom">
                            <h6 class="card-title-custom text-primary"><i class="fa-solid fa-plus-circle"></i> Yeni Ã‡aÄŸrÄ± KaydÄ± OluÅŸtur</h6>
                        </div>
                        <div class="card-body-custom">
                            <form id="callForm" onsubmit="handleFormSubmit(event)">
                                <div class="row g-4">
                                    <div class="col-md-3">
                                        <label class="form-label">Tarih</label>
                                        <input type="date" class="form-control" id="inpDate" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">MÃ¼ÅŸteri Ad Soyad</label>
                                        <input type="text" class="form-control" id="inpName" placeholder="Ad Soyad" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Telefon No</label>
                                        <input type="text" class="form-control" id="inpPhone" placeholder="05..." required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">BÃ¶lge</label>
                                        <select class="form-select" id="inpRegion">
                                            <option value="Ä°stanbul" selected>Ä°stanbul</option>
                                            <option value="Kocaeli">Kocaeli</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Arama Nedeni</label>
                                        <select class="form-select" id="inpReason" required>
                                            <option value="" disabled selected>SeÃ§iniz...</option>
                                            <option>ÃœRÃœN TESLÄ°MATI</option>
                                            <option>ÃœRÃœN ARIZASI</option>
                                            <option>TAKSÄ°T Ä°ÅžLEMLERÄ° / BORÃ‡ BÄ°LGÄ°SÄ°</option>
                                            <option>SERVÄ°S NUMARASI</option>
                                            <option>ÃœRÃœN Ä°PTALÄ° DEÄžÄ°ÅžÄ°MÄ°</option>
                                            <option>ÃœRÃœN BÄ°LGÄ°SÄ°</option>
                                            <option>AVUKATLIK MÃœÅžTERÄ°</option>
                                            <option>EKSÄ°K / HATALI ÃœRÃœN</option>
                                            <option>FATURA Ä°ÅžLEMLERÄ°</option>
                                            <option>SENET Ä°ÅžLEMLERÄ°</option>
                                            <option>KAMP.BÄ°LGÄ°SÄ°</option>
                                            <option>MEMNUNÄ°YET ARAMASI</option>
                                            <option>THH MÃœÅžTERÄ°SÄ°</option>
                                            <option>SÃœREÃ‡LE ALAKALI BÄ°LGÄ° VERÄ°LDÄ°</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">SonuÃ§ / Durum</label>
                                        <select class="form-select" id="inpStatus" required>
                                            <option value="" disabled selected>SeÃ§iniz...</option>
                                            <option>Ã‡Ã–ZÃœMLENDÄ°</option>
                                            <option>Ã‡Ã–ZÃœLENMEDÄ°</option>
                                            <option>TEKRAR GÃ–RÃœÅžÃœLECEK</option>
                                            <option>SÃœREÃ‡LE ALAKALI BÄ°LGÄ° VERÄ°LDÄ°.</option>
                                            <option>YETKÄ°LÄ° SERVÄ°SE YÃ–NLENDÄ°RÄ°LDÄ°</option>
                                            <option>ÅžUBEYE AKTARILDI</option>
                                            <option>GECÄ°KME BÄ°RÄ°MÄ°NE AKTARILDI</option>
                                            <option>Ä°STANBUL SEVK. PLAN. AKTARILDI</option>
                                            <option>Ä°BAN PAYLAÅžILDI</option>
                                            <option>MÃœÅžTERÄ° MEMNUN</option>
                                            <option>ARIZA KAYDI AÃ‡ILDI</option>
                                            <option>Ä°STANBUL MÃœÅž. HÄ°Z. AKTARILDI</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Temsilci</label>
                                        <select class="form-select" id="inpAgent" required>
                                            <option value="" disabled selected>SeÃ§iniz...</option>
                                            <option>BURCU KÃ–SALI</option>
                                            <option>ELVAN ATAK</option>
                                            <option>SEVAL TEKOÄžUL</option>
                                            <option>FEYZA NUR DÄ°LEK</option>
                                            <option>MELÄ°KE KARAPINAR</option>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label">GÃ¶rÃ¼ÅŸme Notu</label>
                                        <textarea class="form-control" id="inpNote" rows="2" placeholder="DetaylÄ± aÃ§Ä±klama..."></textarea>
                                    </div>

                                    <div class="col-12 text-end">
                                        <button type="reset" class="btn btn-light border me-2">Temizle</button>
                                        <button type="submit" class="btn btn-primary-custom px-4"><i class="fa-solid fa-floppy-disk me-2"></i>Kaydet</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. BÃ–LÃœM: Filtreleme ve Tablo -->
            <div class="row">
                <div class="col-12">
                    <div class="panel-card">
                        <!-- Filtreleme AlanÄ± -->
                        <div class="card-header-custom bg-light flex-wrap gap-3">
                            <div class="d-flex align-items-center gap-2 flex-grow-1">
                                <i class="fa-solid fa-filter text-muted"></i>
                                <h6 class="card-title-custom mb-0">KayÄ±tlarÄ± Filtrele</h6>
                            </div>
                            
                            <div class="d-flex flex-wrap gap-2 align-items-center" style="max-width: 100%;">
                                <!-- Tarih Filtresi (Tek Tarih) -->
                                <div style="width: 160px;">
                                    <input type="date" class="form-control form-control-sm" id="filterDate" onchange="applyFilters()">
                                </div>
                                <!-- Arama -->
                                <div style="width: 220px;">
                                    <input type="text" class="form-control form-control-sm" id="filterSearch" placeholder="ðŸ” Ä°sim veya Telefon..." onkeyup="applyFilters()">
                                </div>
                                <!-- Selectler -->
                                <div style="width: 180px;">
                                    <select class="form-select form-select-sm" id="filterReason" onchange="applyFilters()">
                                        <option value="">Arama Nedeni</option>
                                    </select>
                                </div>
                                <div style="width: 180px;">
                                    <select class="form-select form-select-sm" id="filterStatus" onchange="applyFilters()">
                                        <option value="">Durum</option>
                                    </select>
                                </div>
                                <div style="width: 140px;">
                                    <select class="form-select form-select-sm" id="filterRegion" onchange="applyFilters()">
                                        <option value="">BÃ¶lge: TÃ¼mÃ¼</option>
                                        <option value="Ä°stanbul">Ä°stanbul</option>
                                        <option value="Kocaeli">Kocaeli</option>
                                    </select>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetFilters()" title="Filtreleri Temizle">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tablo -->
                        <div class="table-responsive">
                            <table class="table table-custom table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th style="width: 120px;">Tarih</th>
                                        <th>MÃ¼ÅŸteri</th>
                                        <th>Telefon</th>
                                        <th>Arama Nedeni</th>
                                        <th>Durum</th>
                                        <th>BÃ¶lge</th>
                                        <th class="text-end" style="width: 100px;">Ä°ÅŸlem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JS ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination & Footer -->
                        <div class="pagination-container bg-white">
                            <small class="text-muted fw-semibold" id="recordCountLabel">0 KayÄ±t Bulundu</small>
                            <nav>
                                <ul class="pagination mb-0" id="paginationControls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- DÃ¼zenleme ModalÄ± -->
    <div class="modal fade" id="editModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-white border-bottom py-3">
                    <h5 class="modal-title fw-bold text-primary"><i class="fa-solid fa-pen-to-square me-2"></i>KayÄ±t DetayÄ± & DÃ¼zenleme</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <form id="editForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Tarih</label>
                                <input type="date" class="form-control" id="editDate">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ad Soyad</label>
                                <input type="text" class="form-control" id="editName">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Telefon</label>
                                <input type="text" class="form-control" id="editPhone">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">BÃ¶lge</label>
                                <select class="form-select" id="editRegion">
                                    <option value="Ä°stanbul">Ä°stanbul</option>
                                    <option value="Kocaeli">Kocaeli</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Neden</label>
                                <select class="form-select" id="editReason"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Durum</label>
                                <select class="form-select" id="editStatus"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Temsilci</label>
                                <select class="form-select" id="editAgent"></select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Not</label>
                                <textarea class="form-control" id="editNote" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="button" class="btn btn-primary-custom px-4" onclick="saveUpdate()">DeÄŸiÅŸiklikleri Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // *** API URL ***
        const API_URL = "https://script.google.com/macros/s/AKfycbzmh0TtUPRgqXpX3mZ7OvytgEg--MBKheEA46hXl7gLTjc23wEahTGugctfGopeikjI4g/exec";

        let allData = [];
        let currentFilteredData = [];
        let chartInstances = {};
        let currentPage = 1;
        const rowsPerPage = 10;
        let editModalObj;
        let originalRowData = null;
        let refreshInterval;

        // Login Fonksiyonu
        function checkPassword(e) {
            e.preventDefault();
            const pass = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('loginError');
            
            if(pass === "12345") {
                // Åžifre DoÄŸru
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // UygulamayÄ± BaÅŸlat
                initializeApp();
            } else {
                // Åžifre YanlÄ±ÅŸ
                errorMsg.classList.remove('d-none');
                document.getElementById('passwordInput').value = '';
            }
        }

        // Uygulama BaÅŸlatÄ±cÄ± (Åžifre girildikten sonra Ã§alÄ±ÅŸÄ±r)
        function initializeApp() {
            editModalObj = new bootstrap.Modal(document.getElementById('editModal'));
            document.getElementById('inpDate').valueAsDate = new Date();
            
            populateFilterOptions();
            copyOptionsToEditModal();

            if (!API_URL || API_URL.includes("BURAYA")) {
                alert("LÃ¼tfen API URL'nizi kontrol edin.");
                document.getElementById('loader').style.display = 'none';
            } else {
                loadData(true);
                refreshInterval = setInterval(() => loadData(false), 5000);
            }
        }

        // window.onload artÄ±k sadece ÅŸifre inputuna odaklanabilir
        window.onload = function() {
            document.getElementById('passwordInput').focus();
        };

        function loadData(showLoader) {
            if(showLoader) document.getElementById('loader').style.display = 'flex';
            
            fetch(API_URL)
                .then(res => res.json())
                .then(data => {
                    allData = data.filter(item => {
                        const m = (item.musteri || "").toString().trim();
                        const t = (item.telefon || "").toString().trim();
                        return m !== "" || t !== "";
                    });
                    
                    applyFilters(false);
                    if(showLoader) document.getElementById('loader').style.display = 'none';
                })
                .catch(err => {
                    console.error(err);
                    if(showLoader) {
                        alert("Veri yÃ¼kleme hatasÄ±!");
                        document.getElementById('loader').style.display = 'none';
                    }
                });
        }

        // --- Form GÃ¶nderimi ---
        function handleFormSubmit(e) {
            e.preventDefault();
            const formData = {
                tarih: document.getElementById('inpDate').value,
                adsoyad: document.getElementById('inpName').value,
                tel: document.getElementById('inpPhone').value,
                neden: document.getElementById('inpReason').value,
                durum: document.getElementById('inpStatus').value,
                temsilci: document.getElementById('inpAgent').value,
                not: document.getElementById('inpNote').value,
                bolge: document.getElementById('inpRegion').value
            };
            sendData(formData, "create");
        }

        // --- Veri GÃ¶nderim/GÃ¼ncelleme ---
        function sendData(payload, type) {
            document.getElementById('loader').style.display = 'flex';
            if (type === "update") editModalObj.hide();

            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert("Ä°ÅŸlem BaÅŸarÄ±lÄ±");
                    if (type === "create") {
                        document.getElementById('callForm').reset();
                        document.getElementById('inpDate').valueAsDate = new Date();
                    }
                    loadData(true);
                } else {
                    alert("Hata: " + result.message);
                    document.getElementById('loader').style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                alert("Sunucu HatasÄ±");
                document.getElementById('loader').style.display = 'none';
            });
        }

        function saveUpdate() {
            if (!originalRowData) return;
            const updatedData = {
                tarih: document.getElementById('editDate').value,
                adsoyad: document.getElementById('editName').value,
                tel: document.getElementById('editPhone').value,
                neden: document.getElementById('editReason').value,
                durum: document.getElementById('editStatus').value,
                temsilci: document.getElementById('editAgent').value,
                not: document.getElementById('editNote').value,
                bolge: document.getElementById('editRegion').value
            };
            const payload = { action: "update", oldData: originalRowData, newData: updatedData };
            sendData(payload, "update");
        }

        // --- Modal ---
        function openEditModal(index) {
            const globalIndex = (currentPage - 1) * rowsPerPage + index;
            const data = currentFilteredData[globalIndex];
            if (!data) return;

            originalRowData = data;

            let dateVal = "";
            if (data.tarih) {
                if(data.tarih.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    dateVal = data.tarih;
                } else {
                    const d = new Date(data.tarih);
                    if (!isNaN(d)) dateVal = d.toISOString().split('T')[0];
                }
            }

            document.getElementById('editDate').value = dateVal;
            document.getElementById('editName').value = data.musteri || "";
            document.getElementById('editPhone').value = data.telefon || "";
            document.getElementById('editNote').value = data.not || "";
            
            setSelectValue('editRegion', data.bolge);
            setSelectValue('editReason', data.konu);
            setSelectValue('editStatus', data.durum);
            setSelectValue('editAgent', data.temsilci);

            editModalObj.show();
        }

        function setSelectValue(id, val) {
            const el = document.getElementById(id);
            if(!el || !val) { if(el) el.value = ""; return; }
            el.value = val;
            if(el.selectedIndex === -1) {
                for(let i=0; i<el.options.length; i++) {
                    if(el.options[i].value.toLowerCase() === val.toString().toLowerCase()) {
                        el.selectedIndex = i;
                        return;
                    }
                }
            }
        }

        // --- Filtreleme (DÃœZELTÄ°LDÄ°: Tarih KaymasÄ± Ã‡Ã¶zÃ¼ldÃ¼) ---
        function applyFilters(resetPage = true) {
            const search = document.getElementById('filterSearch').value.toLowerCase();
            const reason = document.getElementById('filterReason').value;
            const status = document.getElementById('filterStatus').value;
            const region = document.getElementById('filterRegion').value;
            const dateVal = document.getElementById('filterDate').value; 

            currentFilteredData = allData.filter(item => {
                const sName = (item.musteri || "").toString().toLowerCase();
                const sTel = (item.telefon || "").toString();
                const sReason = (item.konu || "");
                const sStatus = (item.durum || "");
                const sRegion = (item.bolge || "");

                const matchSearch = sName.includes(search) || sTel.includes(search);
                const matchReason = reason === "" || sReason === reason;
                const matchStatus = status === "" || sStatus === status;
                const matchRegion = region === "" || sRegion === region;

                // Tarih Filtresi (Local Time DÃ¼zeltmesi)
                let matchDate = true;
                if(dateVal) {
                    if(item.tarih) {
                        let itemDateStr = "";
                        if(item.tarih.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            itemDateStr = item.tarih;
                        } else {
                            const d = new Date(item.tarih);
                            if(!isNaN(d)) {
                                const year = d.getFullYear();
                                const month = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                itemDateStr = `${year}-${month}-${day}`;
                            }
                        }
                        matchDate = (itemDateStr === dateVal);
                    } else {
                        matchDate = false; 
                    }
                }

                return matchSearch && matchReason && matchStatus && matchRegion && matchDate;
            });

            if (resetPage) currentPage = 1;
            renderDashboard(currentFilteredData);
        }

        function resetFilters() {
            document.getElementById('filterSearch').value = "";
            document.getElementById('filterReason').value = "";
            document.getElementById('filterStatus').value = "";
            document.getElementById('filterRegion').value = "";
            document.getElementById('filterDate').value = "";
            applyFilters(true);
        }

        function renderDashboard(data) {
            updateStats(data);
            updateCharts(data);
            renderTable(data);
        }

        function updateStats(data) {
            const total = data.length;
            const resolved = data.filter(d => (d.durum || "").match(/Ã‡Ã–ZÃœMLENDÄ°|MEMNUN|Ä°BAN/i)).length;
            const pending = data.filter(d => (d.durum || "").match(/TEKRAR|AKTARILDI|YÃ–NLENDÄ°RÄ°LDÄ°|ARIZA/i)).length;

            document.getElementById("statTotal").innerText = total;
            document.getElementById("statResolved").innerText = resolved;
            document.getElementById("statPending").innerText = pending;
            document.getElementById('recordCountLabel').innerText = `Toplam ${total} kayÄ±t listelendi`;
        }

        // GRAFÄ°K Ä°ÅžLEMLERÄ° (TOP 5 ve SÄ±ralama)
        function updateCharts(data) {
            const tCounts = {};
            const rCounts = { "Ä°stanbul": 0, "Kocaeli": 0 };
            
            data.forEach(r => {
                const topic = r.konu || "Belirsiz";
                tCounts[topic] = (tCounts[topic] || 0) + 1;
                if (rCounts[r.bolge] !== undefined) rCounts[r.bolge]++;
            });

            // Arama Nedenlerini BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe SÄ±rala ve Ä°lk 5'i Al
            const sortedTopics = Object.entries(tCounts)
                .sort((a, b) => b[1] - a[1]) // DeÄŸere gÃ¶re azalan sÄ±ralama
                .slice(0, 5); // Ä°lk 5'i al

            // Chart.js formatÄ±na Ã§evir
            const topicLabels = sortedTopics.map(item => item[0]);
            const topicData = sortedTopics.map(item => item[1]);

            renderTopicChart(topicLabels, topicData); 
            renderRegionChart(rCounts);
        }

        function renderTopicChart(labels, data) {
            const ctx = document.getElementById('topicChart').getContext('2d');

            if (chartInstances.topic) {
                chartInstances.topic.data.labels = labels;
                chartInstances.topic.data.datasets[0].data = data;
                chartInstances.topic.update('none'); 
            } else {
                chartInstances.topic = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'KayÄ±t',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderRadius: 6,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, grid: { display: true, color:'#f1f5f9' } }, y: { grid: { display: false } } }
                    }
                });
            }
        }

        function renderRegionChart(counts) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (chartInstances.region) {
                chartInstances.region.data.labels = labels;
                chartInstances.region.data.datasets[0].data = data;
                chartInstances.region.update('none');
            } else {
                chartInstances.region = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'KayÄ±t',
                            data: data,
                            backgroundColor: ['#6366f1', '#10b981'],
                            borderRadius: 6,
                            barThickness: 50
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { y: { beginAtZero: true, grid: { display: true, color:'#f1f5f9' } }, x: { grid: { display: false } } }, 
                        plugins: { legend: { display: false } } 
                    }
                });
            }
        }

        function renderTable(data) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            if(pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">KayÄ±t bulunamadÄ±.</td></tr>';
                document.getElementById('paginationControls').innerHTML = '';
                return;
            }

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                let dateStr = row.tarih;
                try {
                    const d = new Date(row.tarih);
                    if (!isNaN(d)) dateStr = d.toLocaleDateString('tr-TR');
                } catch(e) {}

                let badgeClass = "badge-status badge-neutral";
                const st = (row.durum || "").toUpperCase();
                if (st.includes("Ã‡Ã–ZÃœMLENDÄ°") || st.includes("MEMNUN") || st.includes("Ä°BAN")) badgeClass = "badge-status badge-success";
                else if (st.includes("TEKRAR") || st.includes("AKTARILDI") || st.includes("YÃ–NLENDÄ°RÄ°LDÄ°")) badgeClass = "badge-status badge-warning";
                else if (st.includes("ARIZA") || st.includes("Ä°PTAL")) badgeClass = "badge-status badge-danger";

                tr.innerHTML = `
                    <td class="text-muted fw-medium">${dateStr}</td>
                    <td class="fw-bold text-dark">${row.musteri || '-'}</td>
                    <td>${row.telefon || '-'}</td>
                    <td><div class="text-truncate" style="max-width: 150px;" title="${row.konu}">${row.konu || '-'}</div></td>
                    <td><span class="${badgeClass}">${row.durum || '-'}</span></td>
                    <td>${row.bolge || '-'}</td>
                    <td class="text-end">
                        <button class="btn-icon" onclick="openEditModal(${index})">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderPagination(data.length);
        }

        function renderPagination(totalItems) {
            const container = document.getElementById('paginationControls');
            container.innerHTML = '';
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            if (totalPages <= 1) return;

            const createItem = (text, page, isActive = false, isDisabled = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
                li.innerHTML = `<button class="page-link" onclick="changePage(${page})">${text}</button>`;
                return li;
            };

            container.appendChild(createItem('<i class="fa-solid fa-chevron-left"></i>', currentPage - 1, false, currentPage === 1));
            
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                container.appendChild(createItem(i, i, i === currentPage));
            }

            container.appendChild(createItem('<i class="fa-solid fa-chevron-right"></i>', currentPage + 1, false, currentPage === totalPages));
        }

        function changePage(page) {
            const max = Math.ceil(currentFilteredData.length / rowsPerPage);
            if (page < 1 || page > max) return;
            currentPage = page;
            renderTable(currentFilteredData);
        }

        function copyOptionsToEditModal() {
            const copy = (srcId, destId) => { 
                const srcEl = document.getElementById(srcId);
                const destEl = document.getElementById(destId);
                if (srcEl && destEl) {
                    destEl.innerHTML = srcEl.innerHTML; 
                }
            };
            copy('inpReason', 'editReason');
            copy('inpStatus', 'editStatus');
            copy('inpAgent', 'editAgent');
        }

        function populateFilterOptions() {
            const reasonSrc = document.getElementById('inpReason');
            const reasonDest = document.getElementById('filterReason');
            if(reasonSrc && reasonDest) {
                const opts = reasonSrc.innerHTML.replace(/disabled|selected/g, '');
                reasonDest.innerHTML = '<option value="">Arama Nedeni</option>' + opts;
            }

            const statusSrc = document.getElementById('inpStatus');
            const statusDest = document.getElementById('filterStatus');
            if(statusSrc && statusDest) {
                const opts = statusSrc.innerHTML.replace(/disabled|selected/g, '');
                statusDest.innerHTML = '<option value="">Durum</option>' + opts;
            }
        }
    </script>
</body>
</html>
