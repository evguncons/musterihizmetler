<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HEDEF AVM MÜŞTERİ HİZMETLERİ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985' },
                        slate: { 850: '#1e293b' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
                        'input': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'gold': '0 20px 40px -5px rgba(234, 179, 8, 0.25)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; font-size: 14px; }
        
        .card-base {
            background: white;
            border-radius: 1.25rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            overflow: hidden;
        }

        .entry-card {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .entry-card:hover {
            border-color: #3b82f6; 
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
        }

        .custom-table-row {
            transition: all 0.1s ease;
            border-bottom: 1px solid #f1f5f9;
        }
        .custom-table-row:hover { background-color: #f8fafc; }
        
        .table-cell {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            font-size: 0.875rem;
        }

        .input-label {
            display: block;
            font-size: 0.7rem; 
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.35rem;
        }

        .input-field {
            width: 100%;
            padding: 0.7rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1e293b;
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            outline: none;
            transition: all 0.2s;
            height: 42px;
        }
        .input-field:focus {
            background-color: #ffffff;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        .select-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem; font-weight: 700; font-size: 0.9rem; border-radius: 0.75rem;
            transition: all 0.2s; cursor: pointer;
            height: 42px;
        }
        .btn-primary { background-color: #0ea5e9; color: white; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.2); }
        .btn-primary:hover { background-color: #0284c7; transform: translateY(-1px); }
        .btn-secondary { background-color: white; color: #475569; border: 1px solid #cbd5e1; }
        .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; color: #1e293b; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid #f8fafc; }

        .loader { border: 3px solid #f1f5f9; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        @media (max-width: 1024px) {
            .resp-table thead { display: none; }
            .resp-table tbody tr {
                display: flex; flex-direction: column;
                background: white; border: 2px solid #f1f5f9; border-radius: 1rem;
                margin-bottom: 1rem; padding: 1.25rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            }
            .resp-table td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 0.75rem 0; border-bottom: 1px dashed #f1f5f9;
                font-size: 0.95rem;
            }
            .resp-table td:last-child { border-bottom: none; padding-top: 1rem; }
            .resp-table td::before {
                content: attr(data-label);
                font-weight: 800; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase;
                min-width: 100px;
            }
        }
        
        .desktop-table-header th {
            background-color: #f8fafc; color: #64748b; font-weight: 800; text-transform: uppercase;
            font-size: 0.75rem; letter-spacing: 0.05em; padding: 1.25rem 1rem; border-bottom: 2px solid #e2e8f0;
        }
        .desktop-table-row td {
            padding: 1.25rem 1rem; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle;
        }
        .desktop-table-row:hover { background-color: #fcfcfc; }
    </style>
</head>
<body class="pb-12 min-h-screen bg-slate-100 font-sans">

    <!-- GLOBAL LOADING OVERLAY -->
    <div id="globalLoader" class="fixed inset-0 z-[100] bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center transition-all duration-300 hidden">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-slate-200 border-t-brand-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-database text-brand-600 text-lg animate-pulse"></i>
            </div>
        </div>
        <h3 class="text-xl font-bold text-slate-800 mt-6 animate-pulse tracking-tight">Veriler Yükleniyor...</h3>
        <p class="text-sm text-slate-500 font-medium mt-2">Lütfen bekleyiniz, bağlantı kuruluyor.</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 z-[90] bg-slate-100 flex items-center justify-center p-4">
        <div class="bg-white p-8 md:p-10 rounded-3xl shadow-2xl border border-slate-200 w-full max-w-md text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-brand-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-lg shadow-brand-200 text-white mx-auto mb-6 transform rotate-3">
                <i class="fas fa-headset text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">HEDEF AVM</h2>
            <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-8">MÜŞTERİ HİZMETLERİ</p>
            
            <form id="loginForm" class="space-y-4">
                <div class="relative">
                    <i class="fas fa-key absolute left-4 top-4 text-slate-400"></i>
                    <input type="password" id="loginPass" class="input-field pl-10 h-12 text-lg text-center tracking-widest placeholder:tracking-normal placeholder:text-sm" placeholder="Şifrenizi Giriniz">
                </div>
                <button type="submit" class="btn btn-primary w-full h-12 text-base shadow-lg shadow-brand-200/50">GİRİŞ YAP</button>
            </form>
            <p id="loginError" class="text-rose-500 text-xs font-bold mt-4 hidden"><i class="fas fa-exclamation-circle mr-1"></i> Hatalı Şifre!</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden max-w-[1600px] mx-auto px-4 md:px-8 pt-8 space-y-10">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 bg-white p-5 rounded-3xl border border-white/60 shadow-sm sticky top-4 z-40 backdrop-blur-xl bg-white/90">
            <div class="flex items-center gap-5 w-full md:w-auto">
                <div class="w-14 h-14 bg-gradient-to-br from-brand-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-lg shadow-brand-200 text-white shrink-0">
                    <i class="fas fa-headset text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight leading-none">HEDEF AVM</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-sm font-bold text-slate-400">Müşteri Hizmetleri Paneli</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                <div class="text-right hidden sm:block px-2">
                    <span class="block text-[10px] font-extrabold text-slate-400 uppercase tracking-widest">SON VERİ</span>
                    <span id="lastUpdateTime" class="block text-sm font-bold text-slate-700 font-mono">--:--</span>
                </div>
                <button onclick="refreshData(true)" class="btn btn-secondary !py-2.5 !px-5 text-sm shadow-sm">
                    <i class="fas fa-sync-alt text-brand-500"></i> Yenile
                </button>
            </div>
        </header>

        <!-- ANALYTICS SECTION -->
        <div class="grid grid-cols-1 gap-8">
            <div class="flex justify-between items-end border-b border-slate-200 pb-2">
                 <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-chart-pie text-brand-500"></i> Performans Analizi</h3>
                 <div class="flex items-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                    <i class="fas fa-calendar-alt text-slate-400"></i>
                    <select id="periodFilter" onchange="recalculateStats()" class="bg-transparent font-bold text-slate-600 outline-none text-sm cursor-pointer">
                        <option value="all">Tüm Zamanlar</option>
                    </select>
                </div>
            </div>

            <!-- STATS CARDS -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card-base p-6 border-l-4 border-l-indigo-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-extrabold text-slate-400 uppercase tracking-widest mb-1">TOPLAM ÇAĞRI</p>
                        <h4 class="text-3xl font-black text-slate-800 hidden" id="statTotal">0</h4>
                        <div id="statTotalSkeleton" class="h-9 w-24 bg-slate-200 rounded-lg animate-pulse mt-1"></div>
                    </div>
                    <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl"><i class="fas fa-phone"></i></div>
                </div>
                <div class="card-base p-6 border-l-4 border-l-emerald-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-extrabold text-slate-400 uppercase tracking-widest mb-1">ÇÖZÜMLENEN</p>
                        <h4 class="text-3xl font-black text-emerald-600 hidden" id="statResolved">0</h4>
                        <div id="statResolvedSkeleton" class="h-9 w-24 bg-slate-200 rounded-lg animate-pulse mt-1"></div>
                    </div>
                    <div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="card-base p-6 border-l-4 border-l-amber-500 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-extrabold text-slate-400 uppercase tracking-widest mb-1">TEKRAR ARANACAK</p>
                        <h4 class="text-3xl font-black text-amber-600 hidden" id="statPending">0</h4>
                        <div id="statPendingSkeleton" class="h-9 w-24 bg-slate-200 rounded-lg animate-pulse mt-1"></div>
                    </div>
                    <div class="w-12 h-12 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center text-xl"><i class="fas fa-clock"></i></div>
                </div>
            </section>

            <!-- CHARTS -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="card-base p-6 lg:col-span-2">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center"><i class="fas fa-chart-bar"></i></div>
                        <h3 class="text-lg font-bold text-slate-800">En Çok Aranan Konular</h3>
                    </div>
                    <div class="h-[300px] w-full relative">
                        <canvas id="topicChart"></canvas>
                        <div id="topicChartSkeleton" class="absolute inset-0 bg-white z-10 flex items-end justify-between p-4 gap-4 animate-pulse">
                            <div class="w-full bg-slate-100 rounded-t-lg h-[40%]"></div>
                            <div class="w-full bg-slate-200 rounded-t-lg h-[80%]"></div>
                            <div class="w-full bg-slate-100 rounded-t-lg h-[60%]"></div>
                            <div class="w-full bg-slate-200 rounded-t-lg h-[30%]"></div>
                            <div class="w-full bg-slate-100 rounded-t-lg h-[50%]"></div>
                        </div>
                    </div>
                </div>
                <div class="card-base p-6">
                     <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center"><i class="fas fa-map-marked-alt"></i></div>
                        <h3 class="text-lg font-bold text-slate-800">Bölgesel Dağılım</h3>
                    </div>
                    <div class="h-[300px] w-full relative">
                        <canvas id="regionChart"></canvas>
                        <div id="regionChartSkeleton" class="absolute inset-0 bg-white z-10 flex items-end justify-center p-4 gap-4 animate-pulse">
                             <div class="w-16 h-[70%] bg-slate-200 rounded-t-lg"></div>
                             <div class="w-16 h-[40%] bg-slate-100 rounded-t-lg"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- DATA ENTRY -->
        <section class="card-base border-t-4 border-t-brand-500">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                    <span class="w-10 h-10 rounded-xl bg-brand-100 text-brand-600 flex items-center justify-center"><i class="fas fa-plus-circle"></i></span>
                    Yeni Çağrı Kaydı
                </h2>
            </div>
            <div class="p-8 bg-white">
                <div id="inputContainer" class="space-y-6"></div>
                <div class="mt-8 pt-6 border-t border-slate-100 flex flex-col-reverse sm:flex-row justify-end gap-4">
                    <button onclick="addInputRow()" class="btn btn-secondary w-full sm:w-auto px-8"><i class="fas fa-plus-circle text-brand-500"></i> Yeni Satır Ekle</button>
                    <button onclick="submitAllRows()" id="submitBtn" class="btn btn-primary w-full sm:w-auto px-10"><i class="fas fa-paper-plane"></i> Kaydet ve Gönder</button>
                </div>
            </div>
        </section>

        <!-- RECORDS LIST -->
        <section class="card-base flex flex-col min-h-[600px] bg-white">
            <div class="px-8 py-6 border-b border-slate-100 flex flex-col gap-6">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center border border-indigo-100"><i class="fas fa-list-ul text-lg"></i></div>
                        <div><h3 class="text-lg font-bold text-slate-800">Çağrı Listesi</h3><p class="text-xs text-slate-400 font-bold uppercase tracking-wide">TÜM KAYITLAR</p></div>
                    </div>
                    <span class="text-sm font-bold bg-slate-100 text-slate-600 px-4 py-2 rounded-xl border border-slate-200" id="totalRecordsBadge">0 Kayıt</span>
                </div>
                <!-- Filter Grid -->
                <div class="p-5 bg-slate-50 rounded-2xl border border-slate-200 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4">
                    <div><label class="input-label mb-1">Arama</label><div class="relative"><i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i><input type="text" id="filterSearch" placeholder="İsim/Tel..." class="input-field pl-10" onkeyup="filterRecords()"></div></div>
                    
                    <div><label class="input-label mb-1">Tarih</label><input type="date" id="filterDate" class="input-field" onchange="filterRecords()"></div>

                    <div><label class="input-label mb-1">Bölge</label><select id="filterRegion" class="input-field select-field" onchange="populateReasonStatusOptions('filterRegion', 'filterReason', 'filterStatus', true); filterRecords()"><option value="">Tümü</option><option value="İstanbul">İstanbul</option><option value="Kocaeli">Kocaeli</option></select></div>
                    
                    <div><label class="input-label mb-1">Arama Nedeni</label><select id="filterReason" class="input-field select-field" onchange="filterRecords()"><option value="">Tümü</option></select></div>
                    
                    <div><label class="input-label mb-1">Durum</label><select id="filterStatus" class="input-field select-field" onchange="filterRecords()"><option value="">Tümü</option></select></div>

                    <div><label class="input-label mb-1">Temsilci</label><select id="filterAgent" class="input-field select-field" onchange="filterRecords()"><option value="">Tümü</option><option>BURCU KÖSALI</option><option>ELVAN ATAK</option><option>SEVAL TEKOĞUL</option><option>FEYZA NUR DİLEK</option><option>CANSU IŞIK</option></select></div>
                    
                    <div class="flex items-end"><button onclick="clearFilters()" class="btn btn-secondary w-full"><i class="fas fa-eraser"></i> Temizle</button></div>
                </div>
            </div>
            
            <div class="flex-1 overflow-x-auto">
                <table class="w-full text-left resp-table">
                    <thead class="desktop-table-header bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th>Tarih</th>
                            <th>Bölge</th>
                            <th>Müşteri</th>
                            <th>Telefon</th>
                            <th>Arama Nedeni</th>
                            <th>Durum</th>
                            <th>Temsilci</th>
                            <th class="text-right">İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="crmTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div class="px-8 py-4 border-t border-slate-100 bg-slate-50/50 rounded-b-[1.25rem] flex flex-col sm:flex-row justify-between items-center gap-4">
                <span class="text-sm font-bold text-slate-500" id="paginationInfo">Sayfa 1 / 1</span>
                <div class="flex items-center gap-2" id="paginationControls"></div>
            </div>
        </section>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 transition-all duration-300">
        <div class="card-base w-full max-w-2xl shadow-2xl border-0 bg-white max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-10">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-pen-to-square text-brand-500"></i> Kayıt Düzenle</h3>
                <button onclick="closeEditModal()" class="w-10 h-10 rounded-xl flex items-center justify-center bg-white border-2 border-slate-200 text-slate-400 hover:bg-rose-50 hover:text-rose-500 hover:border-rose-200 transition-all"><i class="fas fa-times"></i></button>
            </div>
            <form id="editForm" class="p-8 space-y-5">
                <input type="hidden" id="modalRowIndex"><input type="hidden" id="modalSheetName">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label class="input-label">Tarih</label><input type="datetime-local" id="modalDate" class="input-field bg-slate-100 text-slate-500 cursor-pointer border-slate-200"></div>
                    <div><label class="input-label">Bölge</label><select id="modalRegion" class="input-field select-field bg-slate-100 text-slate-500 cursor-not-allowed border-slate-200" disabled><option value="İstanbul">İstanbul</option><option value="Kocaeli">Kocaeli</option></select></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label class="input-label">Müşteri Ad Soyad</label><input type="text" id="modalName" class="input-field"></div>
                    <div><label class="input-label">Telefon</label><input type="text" id="modalPhone" class="input-field"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label class="input-label">Arama Nedeni</label><select id="modalReason" class="input-field select-field"></select></div>
                    <div><label class="input-label">Durum</label><select id="modalStatus" class="input-field select-field"></select></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label class="input-label">Temsilci</label><select id="modalAgent" class="input-field select-field"><option>BURCU KÖSALI</option><option>ELVAN ATAK</option><option>SEVAL TEKOĞUL</option><option>FEYZA NUR DİLEK</option><option>CANSU IŞIK</option></select></div>
                </div>

                <div>
                    <label class="input-label">Görüşme Notu</label>
                    <textarea id="modalNote" class="input-field h-24 pt-2 resize-none" placeholder="Detaylar..."></textarea>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-slate-100 mt-2">
                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary px-6">Vazgeç</button>
                    <button type="submit" id="editSubmitBtn" class="btn btn-primary px-8">Değişiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div id="deleteModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="card-base w-full max-w-sm p-8 text-center shadow-2xl border-0 bg-white">
            <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-rose-100"><i class="fas fa-trash-alt text-2xl"></i></div>
            <h3 class="text-xl font-black text-slate-800 mb-2">Emin misiniz?</h3>
            <p class="text-sm text-slate-500 font-medium mb-8 px-4 leading-relaxed">Bu kaydı silmek üzeresiniz. Bu işlem geri alınamaz.</p>
            <input type="hidden" id="deleteIndex">
            <div class="flex gap-3 justify-center">
                <button onclick="closeDeleteModal()" class="btn btn-secondary w-full">Vazgeç</button>
                <button onclick="confirmDelete()" id="btnConfirmDelete" class="btn btn-primary bg-rose-600 hover:bg-rose-700 w-full">Evet, Sil</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzmh0TtUPRgqXpX3mZ7OvytgEg--MBKheEA46hXl7gLTjc23wEahTGugctfGopeikjI4g/exec";
        
        let allRecordsData = []; 
        let filteredData = [];
        let chartInstances = {};
        let currentPage = 1;
        const rowsPerPage = 10; 
        let originalRowData = null; 
        
        function checkLogin() {
            const pass = document.getElementById('loginPass').value;
            if(pass === '134679') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                addInputRow(); 
                populateReasonStatusOptions('filterRegion', 'filterReason', 'filterStatus', true);
                refreshData(true);
                setInterval(() => refreshData(false), 30000);
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                document.getElementById('loginPass').classList.add('border-rose-500', 'ring-2', 'ring-rose-200');
            }
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) { e.preventDefault(); checkLogin(); });

        function populateReasonStatusOptions(regionId, reasonId, statusId, isFilter = false) {
            const regionSelect = document.getElementById(regionId);
            const reasonSelect = document.getElementById(reasonId);
            const statusSelect = document.getElementById(statusId);
            if(!regionSelect || !reasonSelect || !statusSelect) return;
            const region = regionSelect.value;
            
            // If no region selected, clear options
            if (!region) {
                reasonSelect.innerHTML = `<option value="">${isFilter ? 'Tümü' : 'Seçiniz'}</option>`;
                statusSelect.innerHTML = `<option value="">${isFilter ? 'Tümü' : 'Seçiniz'}</option>`;
                return;
            }

            let reasons = ["ÜRÜN TESLİMATI", "ÜRÜN ARIZASI", "GENEL BİLGİ"];
            if (region === "İstanbul") reasons.push("TAKSİT İŞLEMLERİ/BORÇ BİLGİSİ");
            else reasons.push("TAKSİT İŞLEMLERİ / BORÇ BİLGİSİ");
            
            let statuses = ["ÇÖZÜMLENDİ", "TEKRAR GÖRÜŞÜLECEK", "ŞUBEYE AKTARILDI", "SEVKİYAT BİRİMİNE AKTARILDI", "GECİKME BİRİMİNE AKTARILDI"];
            if (region === "Kocaeli") statuses.push("SÜREÇLE ALAKALI BİLGİ VERİLDİ.");
            else statuses.push("SÜREÇLE ALAKALI BİLGİ VERİLDİ");
            
            const defaultText = isFilter ? "Tümü" : "Seçiniz";
            const fill = (sel, opts, placeholder) => {
                const oldVal = sel.value;
                sel.innerHTML = `<option value="">${placeholder}</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join('');
                if(oldVal && opts.includes(oldVal)) sel.value = oldVal;
                else sel.value = "";
            };
            fill(reasonSelect, reasons, defaultText);
            fill(statusSelect, statuses, defaultText);
        }

        function refreshData(showFullLoader = false) {
            const timeStr = new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('lastUpdateTime').textContent = timeStr;
            return fetchData(showFullLoader);
        }

        async function fetchWithRetry(url, options = {}, retries = 3, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response;
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        async function fetchData(showFullLoader) {
            try {
                if(showFullLoader) document.getElementById('globalLoader').classList.remove('hidden');
                const targetUrl = `${API_URL}${API_URL.includes('?') ? '&' : '?'}t=${new Date().getTime()}`;
                const response = await fetchWithRetry(targetUrl, { method: "GET", mode: "cors", redirect: "follow" });
                const data = await response.json();
                allRecordsData = data.filter(item => {
                    const m = (item.musteri || "").toString().trim();
                    const t = (item.telefon || "").toString().trim();
                    const d = (item.tarih || "").toString().trim();
                    if (m === "" || t === "" || d === "" || d === "undefined") return false;
                    const mLower = m.toLowerCase();
                    if (mLower.includes("ad soyad") || mLower.includes("müşteri") || mLower === "adı soyadı") return false;
                    return true;
                }).map(item => ({
                    tarih: item.tarih, musteri: item.musteri, telefon: String(item.telefon || ""), 
                    konu: item.konu, durum: item.durum, temsilci: item.temsilci, not: item.not, bolge: item.bolge, donem: item.donem
                })).sort((a, b) => (a.tarih > b.tarih ? -1 : 1));
                const periods = [...new Set(allRecordsData.map(d => d.donem).filter(d => d))];
                const periodSelect = document.getElementById('periodFilter');
                const currentPeriod = periodSelect.value;
                periodSelect.innerHTML = '<option value="all">Tüm Zamanlar</option>' + periods.map(p => `<option value="${p}">${p}</option>`).join('');
                if(periods.includes(currentPeriod)) periodSelect.value = currentPeriod;
                toggleLoadingState(false);
                filterRecords(false); 
                recalculateStats();
            } catch(e) { console.error("Fetch error", e); }
            finally { document.getElementById('globalLoader').classList.add('hidden'); }
        }

        function toggleLoadingState(isLoading) {
            const skeletons = ['statTotalSkeleton', 'statResolvedSkeleton', 'statPendingSkeleton', 'topicChartSkeleton', 'regionChartSkeleton'];
            const dataElements = ['statTotal', 'statResolved', 'statPending'];
            if (!isLoading) {
                skeletons.forEach(id => document.getElementById(id)?.classList.add('hidden'));
                dataElements.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
            }
        }

        function recalculateStats() {
            const periodVal = document.getElementById('periodFilter').value;
            const analyticsData = periodVal === 'all' ? allRecordsData : allRecordsData.filter(d => d.donem === periodVal);
            const total = analyticsData.length;
            const resolved = analyticsData.filter(d => (d.durum || "").match(/ÇÖZÜMLENDİ|MEMNUN|İBAN/i)).length;
            const pending = analyticsData.filter(d => (d.durum || "").toUpperCase().includes("TEKRAR")).length;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statResolved').textContent = resolved;
            document.getElementById('statPending').textContent = pending;
            const topicCounts = {};
            const regionCounts = { "İstanbul": 0, "Kocaeli": 0 };
            analyticsData.forEach(r => {
                const topic = r.konu || "Belirsiz";
                topicCounts[topic] = (topicCounts[topic] || 0) + 1;
                if (regionCounts[r.bolge] !== undefined) regionCounts[r.bolge]++;
            });
            const sortedTopics = Object.entries(topicCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            renderCharts(sortedTopics, regionCounts);
        }

        function renderCharts(topicsData, regionData) {
            const topicCtx = document.getElementById('topicChart').getContext('2d');
            if (chartInstances.topic) chartInstances.topic.destroy();
            chartInstances.topic = new Chart(topicCtx, {
                type: 'bar',
                data: {
                    labels: topicsData.map(i => i[0]),
                    datasets: [{ label: 'Çağrı Sayısı', data: topicsData.map(i => i[1]), backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true }, y: { grid: { display: false } } } }
            });
            const regionCtx = document.getElementById('regionChart').getContext('2d');
            if (chartInstances.region) chartInstances.region.destroy();
            chartInstances.region = new Chart(regionCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(regionData),
                    datasets: [{ label: 'Çağrı Sayısı', data: Object.values(regionData), backgroundColor: ['#6366f1', '#10b981'], borderRadius: 6, barThickness: 50 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }

        function filterRecords(resetPage = true) {
            const searchVal = document.getElementById('filterSearch').value.toLowerCase();
            const dateVal = document.getElementById('filterDate').value;
            const regionVal = document.getElementById('filterRegion').value;
            const statusVal = document.getElementById('filterStatus').value;
            const reasonVal = document.getElementById('filterReason').value;
            const agentVal = document.getElementById('filterAgent').value; 
            
            filteredData = allRecordsData.filter(item => {
                const searchStr = searchVal.trim();
                const matchSearch = String(item.musteri || "").toLowerCase().includes(searchStr) || String(item.telefon || "").includes(searchStr);
                const matchRegion = regionVal === "" || item.bolge === regionVal;
                const matchStatus = statusVal === "" || (item.durum && item.durum.toString().trim() === statusVal.trim());
                const matchReason = reasonVal === "" || (item.konu && item.konu.toString().trim() === reasonVal.trim());
                const matchAgent = agentVal === "" || (item.temsilci && item.temsilci.toString().trim() === agentVal.trim());
                
                let matchDate = true;
                if(dateVal) {
                   if(item.tarih) {
                       let itemDateStr = String(item.tarih).includes('T') ? String(item.tarih).split('T')[0] : String(item.tarih).substring(0, 10);
                       matchDate = (itemDateStr === dateVal);
                   } else matchDate = false;
                }
                return matchSearch && matchRegion && matchStatus && matchReason && matchDate && matchAgent;
            });
            if(resetPage) currentPage = 1;
            renderTable();
        }

        function clearFilters() {
            document.getElementById('filterSearch').value = '';
            document.getElementById('filterDate').value = '';
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterReason').value = '';
            document.getElementById('filterAgent').value = '';
            populateReasonStatusOptions('filterRegion', 'filterReason', 'filterStatus', true);
            filterRecords();
        }

        function formatDisplayDate(raw) {
            if (!raw) return "-";
            const str = String(raw);
            if (str.includes('T')) {
                const parts = str.split('T');
                const d = parts[0].split('-');
                return `${d[2]}.${d[1]}.${d[0]} ${parts[1].substring(0, 5)}`; 
            }
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const p = str.split('-');
                return `${p[2]}.${p[1]}.${p[0]}`;
            }
            return str;
        }

        function renderTable() {
            const tbody = document.getElementById('crmTableBody');
            const totalRecords = filteredData.length;
            document.getElementById('totalRecordsBadge').textContent = `${totalRecords} Kayıt`;
            tbody.innerHTML = '';
            if (totalRecords === 0) { 
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-16 text-slate-400 text-sm italic">Kayıt bulunamadı.</td></tr>'; 
                renderPagination(0); return; 
            }
            const startIndex = (currentPage - 1) * rowsPerPage;
            const pageData = filteredData.slice(startIndex, startIndex + rowsPerPage);
            pageData.forEach((row, idx) => {
                const absoluteIndex = startIndex + idx;
                const tr = document.createElement('tr');
                tr.className = "desktop-table-row group transition-colors hover:bg-slate-50";
                let badgeClass = "bg-slate-100 text-slate-500";
                const st = (row.durum || "").toUpperCase();
                if (st.includes("ÇÖZÜMLENDİ")) badgeClass = "bg-emerald-100 text-emerald-700";
                else if (st.includes("TEKRAR") || st.includes("AKTARILDI")) badgeClass = "bg-amber-100 text-amber-700";
                else if (st.includes("ARIZA") || st.includes("GECİKME")) badgeClass = "bg-rose-100 text-rose-700";
                tr.innerHTML = `
                    <td data-label="Tarih" class="table-cell whitespace-nowrap text-slate-600 font-bold text-xs">${formatDisplayDate(row.tarih)}</td>
                    <td data-label="Bölge" class="table-cell whitespace-nowrap"><span class="bg-indigo-50 text-indigo-700 px-2.5 py-1 rounded-lg text-[10px] font-extrabold uppercase border border-indigo-100 tracking-wide">${row.bolge}</span></td>
                    <td data-label="Müşteri" class="table-cell font-bold text-slate-800 text-sm">${row.musteri}</td>
                    <td data-label="Telefon" class="table-cell text-slate-600 text-xs">${row.telefon}</td>
                    <td data-label="Neden" class="table-cell text-xs font-medium text-slate-600 max-w-[150px] truncate" title="${row.konu}">${row.konu}</td>
                    <td data-label="Durum" class="table-cell"><span class="inline-flex items-center px-2.5 py-1 rounded-lg text-[10px] font-bold border border-transparent shadow-sm ${badgeClass}">${row.durum}</span></td>
                    <td data-label="Temsilci" class="table-cell text-xs font-bold text-slate-500">${row.temsilci}</td>
                    <td data-label="İşlem" class="table-cell"><div class="flex justify-end gap-2">
                        <button onclick="setupEdit(${absoluteIndex})" class="w-9 h-9 flex items-center justify-center rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-600 hover:bg-indigo-100 transition-all shadow-sm"><i class="fas fa-pen text-xs"></i></button>
                        <button onclick="setupDelete(${absoluteIndex})" class="w-9 h-9 flex items-center justify-center rounded-lg bg-rose-50 border border-rose-200 text-rose-600 hover:bg-rose-100 transition-all shadow-sm"><i class="fas fa-trash text-xs"></i></button>
                    </div></td>
                `;
                tbody.appendChild(tr);
            });
            renderPagination(Math.ceil(totalRecords / rowsPerPage));
        }

        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationControls');
            document.getElementById('paginationInfo').textContent = `Sayfa ${currentPage} / ${totalPages || 1}`;
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;
            const createBtn = (icon, page, disabled) => {
                const btn = document.createElement('button');
                btn.innerHTML = icon;
                btn.className = `w-8 h-8 rounded-lg flex items-center justify-center border transition-all text-xs ${disabled ? 'bg-slate-50 text-slate-300' : 'bg-white text-slate-600 hover:border-brand-300 hover:text-brand-600'}`;
                btn.disabled = disabled;
                btn.onclick = () => { if(!disabled) { currentPage = page; renderTable(); }};
                return btn;
            };
            paginationContainer.appendChild(createBtn('<i class="fas fa-chevron-left"></i>', currentPage - 1, currentPage === 1));
            const pageNum = document.createElement('span');
            pageNum.className = "px-3 py-1.5 bg-brand-600 text-white font-bold text-xs rounded-lg";
            pageNum.textContent = currentPage;
            paginationContainer.appendChild(pageNum);
            paginationContainer.appendChild(createBtn('<i class="fas fa-chevron-right"></i>', currentPage + 1, currentPage === totalPages));
        }

        function getTodayDateTime() {
            const now = new Date();
            const msLocal = now.getTime() - (now.getTimezoneOffset() * 60 * 1000);
            return new Date(msLocal).toISOString().slice(0, 16);
        }

        function addInputRow() {
            const container = document.getElementById('inputContainer');
            const div = document.createElement('div');
            div.className = "entry-card animate-[slideIn_0.3s_ease-out]";
            div.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4 mb-4">
                    <div class="lg:col-span-2"><label class="input-label">Tarih</label><input type="datetime-local" class="input-field inp-date" value="${getTodayDateTime()}"></div>
                    <div class="lg:col-span-2"><label class="input-label">Bölge</label><select class="input-field select-field inp-region" onchange="populateReasonStatusOptions(this.id, this.closest('.entry-card').querySelector('.inp-reason').id, this.closest('.entry-card').querySelector('.inp-status').id)"><option value="" disabled selected>Seçiniz</option><option value="İstanbul">İstanbul</option><option value="Kocaeli">Kocaeli</option></select></div>
                    <div class="lg:col-span-3"><label class="input-label">Müşteri Ad Soyad</label><input type="text" class="input-field inp-name" placeholder="Ad Soyad"></div>
                    <div class="lg:col-span-2"><label class="input-label">Telefon</label><input type="text" class="input-field inp-phone" placeholder="05XX..."></div>
                    <div class="lg:col-span-3"><label class="input-label">Temsilci</label><select class="input-field select-field inp-agent"><option value="" disabled selected>Seçiniz</option><option>BURCU KÖSALI</option><option>ELVAN ATAK</option><option>SEVAL TEKOĞUL</option><option>FEYZA NUR DİLEK</option><option>CANSU IŞIK</option></select></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div><label class="input-label">Arama Nedeni</label><select class="input-field select-field inp-reason"></select></div>
                    <div><label class="input-label">Sonuç / Durum</label><select class="input-field select-field inp-status"></select></div>
                    <div class="flex gap-3 items-end">
                        <div class="flex-1"><label class="input-label">Not</label><input type="text" class="input-field inp-note" placeholder="Kısa not..."></div>
                        <button onclick="this.closest('div.entry-card').remove()" class="w-10 h-[42px] rounded-lg bg-slate-50 text-slate-400 hover:bg-rose-50 border border-slate-200 transition-all flex items-center justify-center shrink-0"><i class="fas fa-trash-alt text-sm"></i></button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            const idSuffix = Date.now() + Math.random().toString(36).substr(2, 5);
            div.querySelector('.inp-region').id = `reg_${idSuffix}`;
            div.querySelector('.inp-reason').id = `rea_${idSuffix}`;
            div.querySelector('.inp-status').id = `sta_${idSuffix}`;
            populateReasonStatusOptions(`reg_${idSuffix}`, `rea_${idSuffix}`, `sta_${idSuffix}`);
        }

        async function submitAllRows() {
            const rows = document.querySelectorAll('#inputContainer > div');
            const dataToSend = [];
            let error = false;
            
            for (let row of rows) {
                const name = row.querySelector('.inp-name').value;
                const region = row.querySelector('.inp-region').value;
                
                // Reset styles
                row.style.borderColor = '#e2e8f0';

                // Validation
                if(!region) {
                    row.style.borderColor = '#f43f5e';
                    alert("Lütfen bölge seçiniz.");
                    error = true;
                    break;
                }
                if(!name) {
                    row.style.borderColor = '#f43f5e';
                    alert("Lütfen müşteri adını giriniz.");
                    error = true;
                    break;
                }

                dataToSend.push({
                    tarih: row.querySelector('.inp-date').value.replace('T', ' '),
                    adsoyad: name, tel: row.querySelector('.inp-phone').value,
                    neden: row.querySelector('.inp-reason').value, durum: row.querySelector('.inp-status').value,
                    temsilci: row.querySelector('.inp-agent').value, not: row.querySelector('.inp-note').value,
                    bolge: region
                });
            }

            if(error || dataToSend.length === 0) return;

            const btn = document.getElementById('submitBtn');
            const oldHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loader border-t-white w-5 h-5 mr-2"></span> Gönderiliyor...'; btn.disabled = true;
            try {
                for (const data of dataToSend) { await fetch(API_URL, {method: 'POST', body: JSON.stringify(data)}); }
                document.getElementById('inputContainer').innerHTML = '';
                addInputRow();
                alert("Kayıtlar başarıyla eklendi.");
                refreshData(false); 
            } catch(e) { alert("Hata oluştu."); }
            finally { btn.innerHTML = oldHTML; btn.disabled = false; }
        }

        window.setupEdit = function(idx) {
            const record = filteredData[idx];
            originalRowData = record; 
            document.getElementById('modalDate').value = getTodayDateTime();
            document.getElementById('modalName').value = record.musteri;
            document.getElementById('modalPhone').value = record.telefon;
            document.getElementById('modalRegion').value = record.bolge;
            document.getElementById('modalAgent').value = record.temsilci;
            document.getElementById('modalNote').value = record.not;
            populateReasonStatusOptions('modalRegion', 'modalReason', 'modalStatus');
            document.getElementById('modalReason').value = record.konu;
            document.getElementById('modalStatus').value = record.durum;
            document.getElementById('editModal').classList.remove('hidden');
        }

        window.setupDelete = function(idx) {
            originalRowData = filteredData[idx]; 
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        window.closeEditModal = function() { document.getElementById('editModal').classList.add('hidden'); }
        window.closeDeleteModal = function() { document.getElementById('deleteModal').classList.add('hidden'); }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('editSubmitBtn');
            const oldHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loader border-t-white w-4 h-4 mr-2"></span>'; btn.disabled = true;
            const newData = {
                tarih: document.getElementById('modalDate').value.replace('T', ' '),
                adsoyad: document.getElementById('modalName').value,
                tel: document.getElementById('modalPhone').value,
                neden: document.getElementById('modalReason').value,
                durum: document.getElementById('modalStatus').value,
                temsilci: document.getElementById('modalAgent').value,
                not: document.getElementById('modalNote').value,
                bolge: document.getElementById('modalRegion').value
            };
            try {
                const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({ action: "update", oldData: originalRowData, newData: newData })});
                const resJson = await res.json();
                if(resJson.success) { closeEditModal(); alert("Kayıt başarıyla güncellendi."); refreshData(false); }
                else { alert("Güncelleme başarısız: " + resJson.message); }
            } catch(e) { alert("Hata"); }
            finally { btn.innerHTML = oldHTML; btn.disabled = false; }
        });

        window.confirmDelete = async function() {
            const btn = document.getElementById('btnConfirmDelete');
            const oldHTML = btn.innerHTML;
            btn.innerHTML = '<span class="loader border-t-white w-4 h-4 mr-2"></span>'; btn.disabled = true;
            try {
                const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({ action: "delete", data: originalRowData })});
                const resJson = await res.json();
                if(resJson.success) { closeDeleteModal(); alert("Kayıt silindi."); refreshData(false); }
                else { alert("Silme başarısız"); }
            } catch(e) { alert("Hata"); }
            finally { btn.innerHTML = oldHTML; btn.disabled = false; }
        }
    </script>
</body>
</html>
